# Customise this file, documentation can be found here:
# https://github.com/fastlane/fastlane/tree/master/fastlane/docs
# All available actions: https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Actions.md
# can also be listed using the `fastlane actions` command

# Change the syntax highlighting to Ruby
# All lines starting with a # are ignored when running `fastlane`

# If you want to automatically update fastlane if a new version is available:
# update_fastlane

#
# This file was created by the help of https://gist.github.com/ulhas/e8e529d08849b8cda947
#

# NOTE: To use faslane install:
#           gem install bundler 
#           brew install git-flow
#           brew install appledoc
#
#     Git-flow witll be configured upon installation or the first run of fastlane.
#     IMPORTANT: Use the default options !!!
#
#   and then run:
#           bundle exec fastlane release bump_type:"minor"

# This is the minimum version number required. 
# Update this, if you use features of a newer version.
fastlane_version "2.105.2"

default_platform :ios

before_all do
  # This block is called, before execute the lane
end


after_all do |lane|
  # This block is called, only if the executed lane was successful
end


error do |lane, exception|
  # Reset builld/version number increment after failed release
  sh "git reset --hard"
end


###############################################################################
#                          PUBLIC SECTION
###############################################################################

desc "Creates a release branch"
desc "Runs framework tests"
desc "Increments framework number"
desc "Updates podspec file"
desc "Pushes podspec file to Cocoapods"
desc "Pushes releases to github"
desc "Commits and pushes changes to remote and tags the release commit"
lane :release do |options|

  podspecs = Dir["../*.podspec"]
  UI.user_error!("No podspecs found") if podspecs.count == 0
  UI.user_error!("Multiple podspecs found") if podspecs.count > 1

  framework = File.basename(podspecs[0], ".podspec")
  repository_name = "blackjacx/#{framework}"
  UI.user_error!("Framework name not found from #{podspecs}") if framework.nil? || framework.empty?

  bump_type = options[:bump_type]
  UI.user_error!("bump_type not specified. Please specify \"major\", \"minor\" or \"patch\"!") if bump_type.nil? || bump_type.empty?

  # Ensure the source code is OK and tests are green
  ensure_bundle_exec
  ensure_git_status_clean
  ensure_git_branch(branch: "develop")
  
  # Delete local branches and tags not on remote to prevent pushing unwanted tags
  sh "git fetch --prune --prune-tags"
  # Pull develop/master to be sure we're up to date everywherre
  sh "git pull && git checkout master && git pull && git checkout develop"

  # Sets CFBundleShortVersionString"
  version = increment_version_number(xcodeproj: "#{framework}.xcodeproj", bump_type: bump_type)
  UI.user_error!("No version number generated by bump") if version.nil? || version.empty?
  UI.user_error!("Git tag #{version} already exists") if git_tag_exists(tag: version)

  # Increment CFBundleVersion by one
  build_number = increment_build_number(xcodeproj: "#{framework}.xcodeproj")
  UI.user_error!("No build number generated by bump") if build_number.nil? || build_number.empty?

  # Check if Github release exists
  github_release = get_github_release(url: repository_name, version: version).
  UI.user_error!("Github release #{version} already exists") if !github_release.nil? && !github_release.empty?

  # Updates framework podspec version
  version_bump_podspec(path: "#{framework}.podspec", version_number: version)

  update_mit_license

  # Read the "Unreleased" changelog section
  changelog = read_changelog(
    section_identifier: '[Unreleased]', # Specify what section to read
    excluded_markdown_elements: []  # Specify which markdown elements should be excluded
  )

  # Write the changelog to a new section named with the release version
  stamp_changelog(
    section_identifier: version # Stamp Unreleased section with newly released build number
  )

  # Check if podspec is ok and tests succeed
  pod_lib_lint(allow_warnings: true)
  test(framework: framework)

  #
  # Start the release
  #

  release_branch = "release/#{version}"

  sh "git checkout -b #{release_branch}"
  sh "git commit -am 'Fastlane: Release on Production #{version}'"

  # Finish the release branch. The shell may hang here because it: 
  # 1) promts for a merge message.
  # 
  # To get around this do the following:
  # 1) git config --global core.mergeoptions --no-edit
  tag_message = "production_release_#{version}"
  sh "git checkout master"
  sh "git merge --no-ff #{release_branch}"
  sh "git tag -m #{tag_message} -a #{version}"
  sh "git checkout develop"
  sh "git merge --no-ff #{release_branch}"
  sh "git branch -d #{release_branch}"

  sh "git push origin develop"
  sh "git push origin master"
  sh "git push origin -f --tags"

  # Pushes framework podspec to Cocoapods specs
  # Needs to be done at the end (expects git tag to be available)
  pod_push(path: "#{framework}.podspec", allow_warnings: true)

  # Create a Carthage archive which is then added to the github release, to enable carthage caching
  carthage_archive_name = "#{framework}.framework.zip"
  sh "cd .. && carthage build --no-skip-current"
  carthage(command: "archive", output: "#{carthage_archive_name}")

  # Creates new release on Github with changelog + pushes the tag if not done already
  set_github_release(
    repository_name: repository_name,
    api_token: ENV["GITHUB_TOKEN"],
    name: version,
    tag_name: version,
    description: (changelog || "No changelog provided"),
    commitish: "master",
    upload_assets: ["#{carthage_archive_name}"],
  )
end


desc "Runs tests using scan"
lane :test do |options|
  framework = options[:framework]
  UI.user_error!("No framework specified") if framework.nil? || framework.empty?

  schemes = sh "xcodebuild -workspace ../#{framework}.xcworkspace -list"

  xargs="-maximum-parallel-testing-workers 1 -parallel-testing-enabled NO -maximum-concurrent-test-simulator-destinations 1 -disable-concurrent-destination-testing"

  # only run the cocoapods action if there is a podfile
  cocoapods(repo_update: true) if File.file?("../Podfile")

  scan(scheme: "#{framework}-iOS", clean: true, xcargs: xargs) if schemes.include? "iOS"
  scan(scheme: "#{framework}-tvOS", clean: true, xcargs: xargs) if schemes.include? "tvOS"
  scan(scheme: "#{framework}-watchOS", clean: true, xcargs: xargs) if schemes.include? "watchOS"
  scan(scheme: "#{framework}-macOS", clean: true, xcargs: xargs) if schemes.include? "macOS"

  danger(verbose: true) if is_set( options[:run_danger] )
end

desc "An contained area for testing new features or running parts of other lanes."
lane :playground do |options|
end


###############################################################################
#                          PRIVATE SECTION
###############################################################################

desc "Updates the LICENSE file to MIT by replacing year and authors from a template file."
private_lane :update_mit_license do |options|
  fAuthors = "../AUTHORS"
  UI.user_error!("#{fAuthors} not found! Quit...") unless File.file?("#{fAuthors}")

  fLicense = "../LICENSE"
  UI.user_error!("#{fLicense} not found! Quit...") unless File.file?("#{fLicense}")

  authors = File.read("#{fAuthors}")
    .gsub(/\n/, ", ")

  data = download(url: "https://raw.githubusercontent.com/Blackjacx/Scripts/master/LICENSE_MIT")
    .gsub(/<year>/, "#{Time.now.year}")
    .gsub(/<copyright holders>/, "#{authors}")

  newFile = File.open("#{fLicense}", "w")
  newFile.write(data)
  newFile.close
end

###############################################################################
# Global Functions
###############################################################################

def is_set(var)
  !var.nil? && !var.empty? && (var == "pull_request" || var == "1" || var == "true")
end